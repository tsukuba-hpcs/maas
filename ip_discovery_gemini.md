# MaaS IPディスカバリーと到達不能IPの登録に関する調査結果

## 概要
MaaSのネットワークディスカバリー機能において、Pingが通らない（到達不能な）IPアドレスが登録され続ける原因は、MaaSのディスカバリー機能の仕様によるものです。**検出された近隣ノード（Neighbour）情報は、自動的に有効期限切れ（expire）にならず、手動で削除されるか、新しいMACアドレスで上書きされるまで永続的に保持されます。**

## 詳細調査結果

### 1. ネットワークディスカバリーの仕組み
MaaSは2つの方法でネットワーク上のデバイスを検出します。

*   **パッシブ検出 (Passive Discovery):**
    *   **動作:** ラックコントローラー上のエージェント（`netmon`）が、ネットワークインターフェース上の **ARP (Address Resolution Protocol)** および **mDNS** パケットを常に監視（リスニング）しています。
    *   **検出契機:** ネットワーク上で何らかのARP通信（Who-has または Is-at）が行われ、その中にIPとMACのペアが含まれていれば、MaaSはそれを「検出」としてデータベースに登録します。
    *   **Ping応答との関係:** ターゲット機器がICMP Echo (Ping)に応答しない設定（ファイアウォール等）であっても、その機器がゲートウェイを探すためにARPリクエストを発信したり、他の機器からのARPリクエストに応答していれば、MaaSはそれを検知します。

*   **アクティブ検出 (Active Discovery):**
    *   **動作:** 定期的（設定による）または手動で、指定されたサブネットに対してスキャンを実行します。
    *   **ツール:** `nmap` (利用可能な場合) または `ping` を使用します。
    *   **詳細:** `nmap` 使用時は `-sn -PR` オプションが使われ、これはARP Pingを実行します。ローカルネットワーク内では非常に信頼性の高い検出方法です。

### 2. 到達不能なIPが登録される原因
`163.220.253.45` が 'Destination Host Unreachable' となるにもかかわらず登録されている理由は以下のいずれか（または組み合わせ）です。

1.  **過去の履歴情報:** そのIPを持つデバイスが過去に一度でもネットワーク上に存在し、ARPパケットを発信（または応答）した場合、MaaSはその情報を登録しました。その後、デバイスがオフラインになっても、MaaSは自動的にそのエントリを削除しません。
2.  **ARPのみ応答:** ICMP (Ping) はブロックしているが、ARPには応答する（または自らARPを発信している）デバイスである可能性があります。
3.  **スプーフィング/誤検出:** 別のデバイスがそのIPに関するARPパケットを送信した可能性があります。

### 3. IPアドレスの有効期限と削除ロジック
コードベースの調査 (`src/maasserver/models/neighbour.py`, `src/maasagent/internal/netmon/service.go`, `src/maasserver/start_up.py`) の結果、以下の仕様が確認されました。

*   **自動削除なし:** ディスカバリーで検出されたエントリ（Neighbourモデル）を、時間の経過（TTL）によって自動削除する定期タスクは存在しません。
*   **更新ロジック:** 同じIPアドレスで新しいMACアドレスが検出された場合のみ、古いエントリが「移動（Moved）」として扱われ、更新（または置換）されます。
*   **クリーンアップ:** 起動時などに一部の「Unknown」なインターフェース情報のクリーンアップ処理は存在しますが、ディスカバリーテーブル全体を期間でパージするものではありません。

### 4. 解決策（不要なエントリの削除方法）

古いエントリを削除するには、手動での操作が必要です。

#### WebUI からの削除
1.  **[Network discovery]** (ネットワークディスカバリー) ページに移動します。
2.  **"Clear all discoveries"** (すべての検出をクリア) ボタンを使用するか、個別のエントリを選択して削除します。

#### CLI からの削除
以下のコマンドで検出情報をクリアできます。

*   **特定のIPとMACの組み合わせを削除:**
    ```bash
    maas $PROFILE discoveries clear-by-mac-and-ip ip=163.220.253.45 mac=<MACアドレス>
    ```

*   **すべての検出情報を削除（リセット）:**
    ```bash
    maas $PROFILE discoveries clear all=true
    ```
    ※ これを実行しても、現在アクティブなデバイスは次回のパケット検知またはスキャンで即座に再登録されます。

### 5. ディスカバリー設定の確認・変更
不要な検出を減らす、あるいはアクティブスキャンの頻度を変える場合は以下の設定を確認してください。

*   **WebUI:** [Settings] > [Network] > [Network discovery]
    *   **Network discovery:** Enabled/Disabled (パッシブ検知の有効/無効)
    *   **Active subnet mapping interval:** アクティブスキャンの間隔（分）

*   **CLI:**
    ```bash
    # 設定確認
    maas $PROFILE maas get-config name=network_discovery
    maas $PROFILE maas get-config name=active_discovery_interval

    # 設定変更（例: 無効化）
    maas $PROFILE maas set-config name=network_discovery value=disabled
    ```

## まとめ
`163.220.253.45` が登録されているのは不具合ではなく、MaaSが「過去に観測した情報」を永続的に保持する仕様によるものです。現状でPingが通らないのであれば、それは「過去に存在した（Stale）」レコードである可能性が高いです。不要であれば手動でクリアすることを推奨します。
